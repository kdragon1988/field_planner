# 工程01: 環境構築・プロジェクト初期化

## 目的・概要

Field Plannerアプリケーションの開発基盤を構築する。Flutter Desktopプロジェクトの初期化、必要な依存パッケージの選定・追加、およびWebView統合の準備を行う。

## 対応する機能要件

- 全体基盤（FR-01〜FR-05の前提となる環境構築）
- NFR-30: 変換処理をモジュール化（将来の形式追加に耐える）
- NFR-31: プロジェクトフォーマットの後方互換

## 実装タスク詳細

### 1. Flutter Desktop環境セットアップ

```bash
# Flutter SDKのインストール確認
flutter --version

# Desktopサポートの有効化
flutter config --enable-windows-desktop
flutter config --enable-macos-desktop

# プロジェクト作成
flutter create --platforms=windows,macos field_planner
```

### 2. プロジェクト構造設計

```
field_planner/
├── lib/
│   ├── main.dart                    # エントリーポイント
│   ├── app.dart                     # アプリケーションルート
│   ├── core/                        # コア機能
│   │   ├── constants/               # 定数定義
│   │   ├── exceptions/              # カスタム例外
│   │   ├── utils/                   # ユーティリティ
│   │   └── extensions/              # 拡張メソッド
│   ├── data/                        # データ層
│   │   ├── models/                  # データモデル
│   │   ├── repositories/            # リポジトリ
│   │   └── services/                # サービス
│   ├── domain/                      # ドメイン層
│   │   ├── entities/                # エンティティ
│   │   └── usecases/                # ユースケース
│   ├── presentation/                # プレゼンテーション層
│   │   ├── screens/                 # 画面
│   │   ├── widgets/                 # ウィジェット
│   │   ├── providers/               # 状態管理
│   │   └── themes/                  # テーマ
│   └── infrastructure/              # インフラ層
│       ├── file_system/             # ファイルシステム操作
│       ├── webview/                 # WebView連携
│       └── converters/              # データ変換
├── assets/                          # アセットファイル
│   ├── models/                      # 3Dモデル（テント等）
│   ├── icons/                       # アイコン
│   └── cesium/                      # CesiumJS関連ファイル
├── windows/                         # Windows固有設定
├── macos/                           # macOS固有設定
├── test/                            # テストコード
└── plans/                           # 開発計画書
```

### 3. 依存パッケージ選定・追加

#### pubspec.yaml に追加するパッケージ

```yaml
dependencies:
  flutter:
    sdk: flutter

  # 状態管理
  riverpod: ^2.5.0
  flutter_riverpod: ^2.5.0

  # WebView（CesiumJS表示用）
  webview_windows: ^0.4.0          # Windows用
  webview_flutter: ^4.4.0          # 汎用

  # ファイル操作
  file_picker: ^6.1.0              # ファイル選択ダイアログ
  path_provider: ^2.1.0            # パス取得
  path: ^1.8.0                     # パス操作

  # データ永続化
  shared_preferences: ^2.2.0       # 設定保存
  hive: ^2.2.0                     # ローカルDB
  hive_flutter: ^1.1.0

  # シリアライズ
  json_annotation: ^4.8.0
  freezed_annotation: ^2.4.0

  # UI
  flutter_svg: ^2.0.0              # SVGアイコン
  window_manager: ^0.3.0           # ウィンドウ管理
  split_view: ^3.2.0               # 分割ビュー

  # ユーティリティ
  uuid: ^4.2.0                     # UUID生成
  intl: ^0.18.0                    # 国際化
  archive: ^3.4.0                  # ZIP操作
  logging: ^1.2.0                  # ロギング

dev_dependencies:
  flutter_test:
    sdk: flutter
  flutter_lints: ^3.0.0
  build_runner: ^2.4.0
  json_serializable: ^6.7.0
  freezed: ^2.4.0
  hive_generator: ^2.0.0
```

### 4. WebView2/WKWebView統合準備

#### Windows (WebView2)

- `windows/runner/CMakeLists.txt` に WebView2 NuGet パッケージ参照を追加
- WebView2 Runtime のインストール確認ロジックを実装

#### macOS (WKWebView)

- `macos/Runner/Info.plist` に必要な権限を追加
- App Sandbox設定（ネットワークアクセス許可）

```xml
<!-- macos/Runner/DebugProfile.entitlements -->
<key>com.apple.security.network.client</key>
<true/>
<key>com.apple.security.files.user-selected.read-write</key>
<true/>
```

### 5. 基本設定ファイルの作成

#### アプリケーション定数

```dart
// lib/core/constants/app_constants.dart
class AppConstants {
  static const String appName = 'Field Planner';
  static const String appVersion = '1.0.0';
  static const String projectExtension = '.agproj';
  static const int autoSaveIntervalSeconds = 120;
  static const int maxRecentProjects = 10;
}
```

#### ログ設定

```dart
// lib/core/utils/logger.dart
import 'package:logging/logging.dart';

void setupLogging() {
  Logger.root.level = Level.ALL;
  Logger.root.onRecord.listen((record) {
    // ファイルパス等の機微情報をマスク
    final message = _sanitizeMessage(record.message);
    print('${record.level.name}: ${record.time}: $message');
  });
}
```

## 技術的な考慮事項

1. **クロスプラットフォーム対応**
   - Windows と macOS で WebView の実装が異なるため、抽象化レイヤーを設ける
   - Platform Channel を使用してネイティブ機能にアクセス

2. **パフォーマンス**
   - 大規模プロジェクトでも起動が遅くならないよう、遅延初期化を活用
   - WebView の初期化は非同期で行う

3. **エラーハンドリング**
   - グローバルエラーハンドラを設定
   - クラッシュレポート機能の準備（ローカル保存）

4. **テスト容易性**
   - 依存性注入（DI）パターンを採用
   - インターフェースを定義してモック可能に

## 成果物・完了条件

- [ ] Flutter Desktopプロジェクトが作成され、Windows/macOSでビルド・実行可能
- [ ] 上記のディレクトリ構造が作成されている
- [ ] 全ての依存パッケージがインストールされ、`flutter pub get` が成功
- [ ] WebView統合の準備（設定ファイル変更）が完了
- [ ] 基本的なログ出力が動作
- [ ] 空のメイン画面が表示される

## 次工程への引き継ぎ事項

- WebView の実装詳細は工程02で実施
- プロジェクト管理のデータモデルは工程03で設計
