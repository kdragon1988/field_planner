1. 文書概要

1.1 目的

DJI Terra等から出力した3Dデータ（メッシュ）および点群を取り込み、Cesium 3D Map / Google Maps 等の地図レイヤー上で表示し、イベント会場（テント・ステージ等）を “Minecraftのように” 直感的に配置して、計測・保存・共有（ローカル保存のみ）を行うデスクトップアプリを構築する。

1.2 対象プラットフォーム
	•	Windows 10/11（x64）
	•	macOS 12+（Apple Silicon優先、Intelは要検討）

1.3 前提・制約
	•	プロジェクトデータ保存は ローカルのみ（クラウド保存なし）
	•	プロジェクト共有は ファイル（フォルダ/ZIP） で受け渡し
	•	ベースマップ（Cesium/Google等）のオンライン取得は 許容（ただし「データ保存はローカルのみ」とは別概念として扱う）
	•	Google Maps利用はAPIキーと利用規約の遵守が必須（オフラインキャッシュは規約面の確認が必要）

⸻

2. 用語
	•	プロジェクト：会場設計単位。3Dデータ参照、配置物、計測、表示設定を含む
	•	アセット：テント/ステージ/バリケード等の配置用3Dモデル（内蔵・同梱）
	•	レイヤー：ベースマップ、3Dデータ、点群、配置物、注釈、計測結果などの表示単位
	•	3D Tiles：Cesiumで扱いやすい3Dデータ形式（点群/メッシュ対応）

⸻

3. ユースケース（主要フロー）

UC-01 新規プロジェクト作成
	1.	プロジェクト名・保存先を指定
	2.	ベースマップ（Cesium/Google/OSM等）選択
	3.	初期座標（会場中心）・座標系設定
	4.	作成完了 → 編集画面へ

UC-02 3Dデータ/点群の取り込み
	1.	「インポート」からファイル選択（OBJ/FBX/PLY/LAS/LAZ等）
	2.	変換が必要な場合：ローカル変換（3D Tiles化）を実行
	3.	レイヤーとして追加、位置合わせ（ジオリファレンス/手動補正）
	4.	保存

UC-03 アセット配置（Minecraft風）
	1.	アセットパレットからアイテム選択
	2.	地面スナップ/グリッドスナップで配置
	3.	回転・スケール・高さ調整
	4.	複製、整列、グループ化
	5.	保存

UC-04 計測（長さ・面積等）
	1.	計測ツール選択（距離/面積/高さ）
	2.	クリックで点を打つ（ポリライン/ポリゴン）
	3.	結果表示（単位切替）＋命名＋保存
	4.	エクスポート（CSV/GeoJSON/JSON）

UC-05 共有
	1.	プロジェクトをフォルダとして保存
	2.	「共有用エクスポート」でZIP化（参照ファイルも同梱/コピー）
	3.	別PCで「インポート」→ 同一状態で復元

⸻

4. 機能要件（FR）

4.1 プロジェクト管理
	•	FR-01：プロジェクト新規作成/開く/保存/別名保存
	•	FR-02：プロジェクトの最近使った履歴（MRU）
	•	FR-03：プロジェクト共有用エクスポート（ZIP）
	•	FR-04：共有プロジェクトのインポート（ZIP→展開→整合性チェック）
	•	FR-05：プロジェクト単位のメタ情報（作成者/作成日/説明/タグ）

4.2 3Dデータ・点群の取り込み/表示
	•	FR-10：対応入力（優先）
	•	点群：LAS/LAZ、PLY（点）、E57（要検討）
	•	メッシュ：OBJ/MTL、FBX、glTF/GLB
	•	FR-11：表示最適化
	•	点群のダウンサンプル/LOD
	•	3D Tiles化によるストリーミング表示
	•	FR-12：座標系/位置合わせ
	•	ジオリファレンス情報がある場合は自動配置
	•	無い場合は「既知点合わせ」「手動平行移動/回転/スケール」
	•	FR-13：レイヤー管理（表示ON/OFF、不透明度、順序、ロック）
	•	FR-14：地形（Terrain）と重ね合わせ、地表スナップ

実務上、DJI Terraの出力は「そのままCesiumで快適に」になりにくいので、ローカル変換（3D Tiles化）を標準機能として扱うのが仕様として堅いです。

4.3 ベースマップ（Cesium / Google Maps）
	•	FR-20：ベースマップ選択
	•	Cesium imagery（Bing/ESRI等：設定により）
	•	Google Maps（要APIキー）
	•	OSM等（タイルURL指定）
	•	FR-21：複数レイヤー重畳（透過、順序）
	•	FR-22：2D/3D表示切替（可能なら）

4.4 アセット配置（会場デザイン）
	•	FR-30：アセットフォルダ（内蔵）からの読み込み
	•	FR-31：アセットパレット（カテゴリ/検索/お気に入り）
	•	FR-32：配置操作
	•	クリック配置、ドラッグ移動
	•	回転（スナップ角度：例 15°）
	•	スケール（等倍/軸別）
	•	高さ調整（地形追従/絶対高度）
	•	FR-33：スナップ
	•	地面スナップ
	•	グリッドスナップ（設定可能：0.1m/0.5m/1m等）
	•	既存オブジェクトへのスナップ（任意）
	•	FR-34：複製（Ctrl+D）、整列、グループ化、ロック
	•	FR-35：プロパティ（名称、寸法、材質/色、タグ）
	•	FR-36：衝突判定の簡易チェック（オプション、警告表示）

4.5 計測機能
	•	FR-40：距離計測（2点/多点ポリライン）
	•	FR-41：面積計測（ポリゴン）
	•	FR-42：高さ/標高差（2点、または点→地形）
	•	FR-43：周長、角度（オプション）
	•	FR-44：計測結果の表示と保存（名前、色、単位、備考）
	•	FR-45：計測結果のエクスポート（CSV/JSON/GeoJSON）
	•	FR-46：スナップ（頂点スナップ、地形スナップ）

4.6 表示・UI
	•	FR-50：ビュー操作（回転/パン/ズーム、ホーム復帰）
	•	FR-51：検索（座標/地名：可能なら）
	•	FR-52：スクリーンショット出力（PNG）
	•	FR-53：簡易ビューモード（プレゼン用：UI最小化）

⸻

5. 非機能要件（NFR）

5.1 性能
	•	NFR-01：10M点規模の点群は「そのまま」だと厳しいため、タイル化/LOD化後に快適表示を目標
	•	NFR-02：配置編集の操作遅延：体感100ms以内（理想）
	•	NFR-03：大規模プロジェクト（数百配置物＋計測多数）でも保存/読込が破綻しない

5.2 信頼性
	•	NFR-10：自動保存（例：2分毎、世代管理）
	•	NFR-11：クラッシュ時復元（リカバリ）
	•	NFR-12：プロジェクト整合性チェック（参照ファイル欠落検知）

5.3 セキュリティ/プライバシー
	•	NFR-20：外部送信なし（ただし地図タイル取得は別扱いで明記）
	•	NFR-21：ログに機微情報（パス等）を残さない設定

5.4 保守性
	•	NFR-30：変換処理をモジュール化（将来の形式追加に耐える）
	•	NFR-31：プロジェクトフォーマットの後方互換（schema version）

⸻

6. 技術アーキテクチャ案（Flutter前提）

6.1 全体構成（推奨）
	•	UI：Flutter Desktop
	•	3D地図・表示：CesiumJS（Web）を埋め込み表示
	•	Windows：WebView2 / CEF（要選定）
	•	macOS：WKWebView / CEF
	•	ネイティブ連携：Flutter ↔ Web（JS Bridge）
	•	配置・計測などの操作イベント、プロジェクトJSONの同期

6.2 変換パイプライン（ローカル）
	•	点群：
	•	LAS/LAZ →（PDAL/Entwine等）→ タイル/LOD → Cesium 3D Tiles（Point Cloud）
	•	メッシュ：
	•	OBJ/FBX/GLB →（変換ツール）→ 3D Tiles（B3DM/GLB系）
	•	変換はバックグラウンドジョブ化（進捗％、キャンセル、ログ）

「ローカルのみ」縛りがあるため、Cesium ion等のクラウド変換は オプション扱い にして、基本はローカル変換を仕様に入れるのが安全です。

⸻

7. データ設計

7.1 プロジェクト保存形式
	•	1プロジェクト = 1フォルダ
	•	例：MyProject.agproj/
	•	project.json（メタ/設定/参照）
	•	layers/（3D Tiles等、生成物）
	•	imports/（元データのコピー or 外部参照）
	•	placements.json（配置物一覧）
	•	measurements.json（計測一覧）
	•	thumbnails/（サムネ、スクショ）
	•	assets_manifest.json（アセット定義）

7.2 project.json（例：主要キー）
	•	schemaVersion
	•	name, description, createdAt, updatedAt
	•	baseMap: provider, apiKeyRef(保持しない方針なら設定側へ), layers
	•	scene: center(lat/lon/height), camera, terrain
	•	dataLayers: 3DTilesのパス、表示設定、変換元メタ
	•	units: m/ft, areaUnit
	•	coordinate: EPSG, localOffset, anchorPoints

7.3 配置物データ（placements.json）
	•	id, assetId, name
	•	position（lat/lon/height or ENU/local）
	•	rotation, scale
	•	properties（タグ、色など）
	•	groupId, locked, visible

7.4 計測データ（measurements.json）
	•	id, type（distance/area/height）
	•	points（地理座標配列）
	•	result（数値・単位）
	•	style（色、線幅）
	•	note, createdAt

⸻

8. 画面仕様（UI）

8.1 メイン画面構成
	•	左：レイヤー/アセット/計測タブ
	•	中央：3Dビュー（Cesium）
	•	右：プロパティインスペクタ（選択対象の詳細）
	•	上：ツールバー（選択/移動/回転/スケール/計測/インポート/保存）
	•	下：ステータス（座標、標高、スナップ状態、進捗）

8.2 アセット配置UX（要点）
	•	パレットから選択 → カーソルにプレビュー
	•	クリックで確定、ドラッグで微調整
	•	Shiftでスナップ強制、Altでスナップ解除などのモディファイアキー
	•	グリッド表示ON/OFF

8.3 計測UX
	•	距離：クリック連打で折れ線、ダブルクリックで確定
	•	面積：ポリゴン閉じて確定
	•	結果は画面内ラベル＋一覧に自動追加、名称変更可

⸻

9. 外部依存・ライセンス注意
	•	Google Maps：APIキー管理、課金、規約（キャッシュ/保存）に注意
	•	Cesium：利用形態（CesiumJS、各種タイルソース）によって利用条件が変わる
	•	変換ツール：採用するOSS（PDAL/Entwine等）のライセンス確認

⸻

10. テスト/受け入れ基準（抜粋）

10.1 受け入れ条件（例）
	•	AC-01：プロジェクトをZIPで渡して別PCで同一表示・同一配置・同一計測が復元できる
	•	AC-02：LAS/LAZを取り込み、タイル化後にスムーズに移動/ズームできる
	•	AC-03：アセット配置が地面スナップし、回転/スケール/複製が直感的に行える
	•	AC-04：距離/面積計測を保存し、再起動後も再表示でき、CSV出力できる

⸻

11. 実装上の重要論点（仕様に明記推奨）
	1.	座標系の扱い（DJI Terra出力が何を持っているか、EPSG、ローカル座標への変換方針）
	2.	点群/メッシュの“ローカル変換”標準化（変換しないと実用性能にならないケースが多い）
	3.	Flutterでの3D表示方式（ネイティブ3DではなくCesiumJS埋め込みが現実的）
	4.	Google Mapsの扱い（APIキー、課金、規約、オフライン要件の有無）
	5.	プロジェクト共有の“参照方式”
	•	A) 参照元ファイルをプロジェクト内にコピー（共有が確実、容量増）
	•	B) 外部参照（容量小、共有で欠落しやすい）
→ 仕様として「共有用エクスポート時は必ず同梱コピー」などルール化が必要

⸻

12. 追加提案（拡張余地）
	•	“高さ制限/動線”など会場設計向けのルールチェック
	•	レイヤーごとの透明度アニメーション（演出検討用）
	•	PDF/画像でのレイアウト出力（寸法・面積を図面風に）
